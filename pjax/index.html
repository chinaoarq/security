<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <link rel="stylesheet" href="style.css">
    <link rel='stylesheet' href='https://unpkg.com/nprogress@0.2.0/nprogress.css' />
</head>

<body>
    <h3>1. how forward/back not refresh</h3>
    <h3>2. what is pjax</h3>

    <div id="pages">
        <div href="page1" name="page1">Sub Page1</div>
        <div href="page2" name="page2">Sub Page2</div>
        <div href="page3" name="page3">Sub Page3</div>
    </div>
    <div id="contents">
    </div>
</body>

<script src='https://unpkg.com/nprogress@0.2.0/nprogress.js' async></script>
<script>
    window.onpopstate = function (event) {
        console.log('onpopstate');
        activePage();
    };

    window.onload = function () {
        console.log('onload');
        activePage();
    }

    let $content = document.getElementById("contents");
    let $pages = document.getElementById("pages").getElementsByTagName("div");
    let g_page_contents = [];

    for (let i = 0; i < $pages.length; i++) {
        $pages[i].addEventListener('click', function (event) {
            let page = event.target.attributes['name'].value;
            activePage(page);
            history.pushState({ id: page }, page, "?page=" + page);
        });
    }

    function activePage(page) {
        if (!page) {
            page = getUrlVars()['page'];
        }

        loadContent(page);
    }

    function loadContent(page) {
        let cachedContent = getCachedContent(page);

        console.log('load ' + cachedContent);

        if (cachedContent) {
            $content.innerHTML = cachedContent;
            highlightTab(page);
        } else {
            NProgress.start();
            $content.innerHTML = "loading...";
            setTimeout(function () {
                let content = initContent(page);

                $content.innerHTML = content;
                putContentToCache(content);

                NProgress.done();
                highlightTab(page);
            }, 1000);
        }
    }

    function initContent(page) {
        let content = "";
        let i = 0;
        while (i < 100) {
            content += page + ' value ' + i + '<br />';
            i++;
        }

        return content;
    }

    function putContentToCache(content) {
        let curPageId = history.state.id;

        let cachedContent = getCachedContent(curPageId);
        if (cachedContent) {
            cachedContent = { id: curPageId, content: content };
        } else {
            g_page_contents.push({ id: curPageId, content: content });
        }
    }

    function getCachedContent(pageId) {
        console.log('get ' + pageId);

        for (let i = 0; i < g_page_contents.length; i++) {
            if (g_page_contents[i].id == pageId) {
                return g_page_contents[i].content;
            }
        }
        return null;
    }

    function highlightTab(page) {
        for (let i = 0; i < $pages.length; i++) {
            $pages[i].className = "";
            if ($pages[i].attributes['name'].value === page) {
                $pages[i].className = "active";
            }
        }
    }

    function getUrlVars() {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }

</script>

</html>